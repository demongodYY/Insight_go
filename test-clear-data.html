<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>清除数据功能测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    .test-button:hover {
      background: #0056b3;
    }
    .test-button.danger {
      background: #dc3545;
    }
    .test-button.danger:hover {
      background: #c82333;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      background: #e9ecef;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>清除数据功能测试</h1>
  
  <div class="test-section">
    <h2>测试说明</h2>
    <p>这个页面用于测试插件的清除数据功能。请按照以下步骤操作：</p>
    <ol>
      <li>点击"模拟添加问题"按钮，添加一些测试问题</li>
      <li>点击"模拟清除数据"按钮，清除所有数据</li>
      <li>刷新页面，验证数据是否真的被清除了</li>
      <li>检查控制台日志，了解清除过程</li>
    </ol>
  </div>
  
  <div class="test-section">
    <h2>操作按钮</h2>
    <button class="test-button" onclick="addTestQuestions()">模拟添加问题</button>
    <button class="test-button" onclick="clearAllData()">模拟清除数据</button>
    <button class="test-button" onclick="checkStorage()">检查存储状态</button>
    <button class="test-button" onclick="clearLog()">清空日志</button>
  </div>
  
  <div class="test-section">
    <h2>当前状态</h2>
    <div id="status" class="status">等待操作...</div>
  </div>
  
  <div class="test-section">
    <h2>操作日志</h2>
    <div id="log" class="log"></div>
  </div>
  
  <script>
    // 模拟插件的存储键
    const STORAGE_KEYS = {
      QUESTIONS: 'act-nav-questions-test-chat',
      CLEARED: 'act-nav-data-cleared',
      TIMESTAMP: 'act-nav-clear-timestamp'
    };
    
    // 日志函数
    function log(message, type = 'info') {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `[${timestamp}] ${message}`;
      logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
      logElement.appendChild(logEntry);
      logElement.scrollTop = logElement.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }
    
    // 更新状态显示
    function updateStatus(message, type = 'info') {
      const statusElement = document.getElementById('status');
      statusElement.textContent = message;
      statusElement.className = `status ${type}`;
    }
    
    // 模拟添加测试问题
    async function addTestQuestions() {
      try {
        log('开始添加测试问题...');
        
        const testQuestions = [
          {
            id: 'test-1',
            text: '这是第一个测试问题',
            fullText: '这是第一个测试问题的完整内容',
            timestamp: Date.now(),
            chatId: 'test-chat'
          },
          {
            id: 'test-2',
            text: '这是第二个测试问题',
            fullText: '这是第二个测试问题的完整内容',
            timestamp: Date.now() + 1000,
            chatId: 'test-chat'
          },
          {
            id: 'test-3',
            text: '这是第三个测试问题',
            fullText: '这是第三个测试问题的完整内容',
            timestamp: Date.now() + 2000,
            chatId: 'test-chat'
          }
        ];
        
        // 保存到本地存储
        localStorage.setItem(STORAGE_KEYS.QUESTIONS, JSON.stringify(testQuestions));
        
        log(`成功添加 ${testQuestions.length} 个测试问题`, 'success');
        updateStatus(`已添加 ${testQuestions.length} 个测试问题`, 'success');
        
        // 检查存储状态
        await checkStorage();
        
      } catch (error) {
        log(`添加测试问题失败: ${error.message}`, 'error');
        updateStatus(`添加测试问题失败: ${error.message}`, 'error');
      }
    }
    
    // 模拟清除所有数据
    async function clearAllData() {
      try {
        log('开始清除所有数据...');
        
        // 1. 清除问题数据
        localStorage.removeItem(STORAGE_KEYS.QUESTIONS);
        log('已清除问题数据');
        
        // 2. 设置清除标记
        const clearData = {
          [STORAGE_KEYS.CLEARED]: true,
          [STORAGE_KEYS.TIMESTAMP]: Date.now()
        };
        
        Object.entries(clearData).forEach(([key, value]) => {
          localStorage.setItem(key, JSON.stringify(value));
        });
        
        log('已设置数据清除标记');
        log(`清除时间: ${new Date(clearData[STORAGE_KEYS.TIMESTAMP]).toLocaleString()}`);
        
        // 3. 清除所有以 act-nav- 开头的键
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('act-nav-')) {
            keysToRemove.push(key);
          }
        }
        
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
          log(`已清除存储键: ${key}`);
        });
        
        log('数据清除完成！', 'success');
        updateStatus('数据已完全清除，刷新页面不会恢复', 'success');
        
        // 检查存储状态
        await checkStorage();
        
      } catch (error) {
        log(`清除数据失败: ${error.message}`, 'error');
        updateStatus(`清除数据失败: ${error.message}`, 'error');
      }
    }
    
    // 检查存储状态
    async function checkStorage() {
      try {
        log('检查存储状态...');
        
        const questions = JSON.parse(localStorage.getItem(STORAGE_KEYS.QUESTIONS) || '[]');
        const isCleared = JSON.parse(localStorage.getItem(STORAGE_KEYS.CLEARED) || 'false');
        const clearTimestamp = JSON.parse(localStorage.getItem(STORAGE_KEYS.TIMESTAMP) || '0');
        
        log(`问题数量: ${questions.length}`);
        log(`清除标记: ${isCleared}`);
        
        if (clearTimestamp > 0) {
          const clearTime = new Date(clearTimestamp);
          const now = new Date();
          const timeDiff = now - clearTime;
          const minutes = Math.floor(timeDiff / 1000 / 60);
          
          log(`清除时间: ${clearTime.toLocaleString()}`);
          log(`距离清除时间: ${minutes} 分钟`);
          
          if (isCleared && minutes < 24 * 60) {
            log('数据清除标记有效，24小时内不会恢复数据', 'success');
          } else if (isCleared && minutes >= 24 * 60) {
            log('数据清除标记已过期（超过24小时），允许恢复数据', 'error');
          }
        }
        
        // 检查所有 act-nav- 开头的键
        const actNavKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('act-nav-')) {
            actNavKeys.push(key);
          }
        }
        
        log(`act-nav- 开头的存储键: ${actNavKeys.length} 个`);
        if (actNavKeys.length > 0) {
          actNavKeys.forEach(key => {
            log(`  - ${key}`);
          });
        }
        
        updateStatus(`存储检查完成 - 问题: ${questions.length}, 清除标记: ${isCleared}`, 'info');
        
      } catch (error) {
        log(`检查存储状态失败: ${error.message}`, 'error');
        updateStatus(`检查存储状态失败: ${error.message}`, 'error');
      }
    }
    
    // 清空日志
    function clearLog() {
      document.getElementById('log').innerHTML = '';
      log('日志已清空');
    }
    
    // 页面加载时检查存储状态
    window.addEventListener('load', () => {
      log('页面加载完成，开始检查存储状态');
      checkStorage();
    });
    
    // 页面卸载前保存状态
    window.addEventListener('beforeunload', () => {
      log('页面即将卸载');
    });
  </script>
</body>
</html>
